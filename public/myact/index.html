<html>
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QM71F063G7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-QM71F063G7');
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<!-- Favicon -->
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-act.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32-act.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16-act.png">
<link rel="manifest" href="/site-act.webmanifest">
<!------------------------------------------------------------------>
<!-- Font Awesome -->
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
<!-- Google Fonts -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
<!-- Bootstrap core CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
<!-- Material Design Bootstrap -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">

<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/css/bootstrap-slider.min.css" rel="stylesheet">
<!------------------------------------------------------------------>

<link href="font/css/open-iconic-bootstrap.css" rel="stylesheet">
<title>MyACT</title>
<style>
.progress { height: 2px;}

@media screen and (max-width: 767px){
#map {
 width: auto;
 height: calc(var(--vh, 1vh)*100 - 30px);
 border:1px solid #aaa;
}
#qrvinfo {
 width: auto;
 height: calc(var(--vh, 1vh)*100 - 30px);
 overflow:auto;
 border:1px solid #aaa;
 -webkit-overflow-scrolling:touch;
 }
}
@media screen and (min-width: 768px) {
#map {
 width: auto;
 height:calc(var(--vh, 1vh)*100 - 56px);
 border:1px solid #aaa;
 }
#qrvinfo {
 width: auto;
 height: calc(var(--vh, 1vh)*100 - 56px);
 overflow:auto;
 border:1px solid #aaa;
 -webkit-overflow-scrolling:touch;
 }
}
.modal-header {
    padding-top: 2px;
    height: 34px;
    padding-bottom: 2px;
}
.modal-footer {
    padding-top: 2px;
    height: 24px;
    padding-bottom: 2px;
}
.modal-body > .img-responsive {
    margin-left: auto;
    margin-right: auto;
}
.slider.slider-horizontal {
    width:100px !important;
}
.navbar-dark .navbar-toggler {
border-color: rgba(0,0,0,0);
}
.navbar-toggler-icon {
font-size: 0.8em;
}
.collapse.in {
 height: auto;
}

i.semantic-ui-custom {
  margin-top: 9px;
}
@keyframes blink {
  50% { opacity: 0.3; }
}
@-webkit-keyframes blink {
  50% { opacity: 0.3; }
}
.blink-me {
  animation: blink 1s linear infinite;
  -webkit-animation: blink 1s linear infinite;
}

.btn {
 margin: 0.1rem !important ; padding: 0.4rem 0.5rem !important;
}

.my-tooltip-label {
    color: white;	
    background: transparent;
    border: none;
    box-shadow: none;
    font-size: 8px;
}
</style>

<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/topojson@3.0.2/dist/topojson.min.js"></script> 
<!---------------------------------------------------------------------->
<!-- JQuery -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<!-- Bootstrap tooltips -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
<!-- Bootstrap core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
<!-- MDB core JavaScript -->
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-slider/11.0.2/bootstrap-slider.min.js"></script>
<!-- Chart JS plugins -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.umd.min.js" integrity="sha512-GCiwmzA0bNGVsp1otzTJ4LWQT2jjGJENLGyLlerlzckNI30moi2EQT0AfRI7fLYYYDKR+7hnuh35r3y1uJzugw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<!------------------------------------------------------------------------>
<!-- plugin -->
<link rel="stylesheet" href="css/leaflet.extra-markers.min.css" />
<script src="js/leaflet.extra-markers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.3.1/dist/semantic.min.css">
<link rel="stylesheet" href="js/L.Control.ZoomLabel.css">
<script src="js/L.Control.ZoomLabel.js"></script>
<script src="js/regionfill.js"></script>
<script src="js/getDEM.js"></script>
<script src="js/actzone.js"></script>
<script src="js/search-ref.js"></script>
<script src="js/revgeocoder.js"></script>
<!-- plugin -->

<style type="text/css">
  i.semantic-ui-custom {
  margin-top: 9px;
  }
</style>
</head>

<body>
  <nav class="navbar navbar-expand-md navbar-dark bg-dark text-light">
    <span class="navbar-brand" style="cursor: hand;cursor: pointer;"><h4>MyACT</h4></span>
    <button type="button" class="btn btn-amber" onclick="clickQTHButton()" title="現在位置を調べる"><span class="fas fa-map-marked-alt" ></span></button>
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#spots-data" title="最新スポットを表示"><span class="fas fa-satellite-dish"></span></button>
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#modal-prefs" onclick="clickPrefs()" title="設定"><span class="fas fa-cog"></span></button>
    
    <div id="search_ref"></div>
    <script>
      $("#search_ref").searchinput({width:65,done:function(s){showReference(s)}})
    </script>
    
    <small><span id="clock_time" style="cursor: default;" ></span></small>
  </nav>

  <div class = "modal fade" id="spots-data">
    <div class="modal-dialog" style="max-width: 90%;margin:1rem auto;">
      <div class="modal-content">
	<div class="modal-header">
	  <div class="dropdown">
	    <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" id="program_dropdown">
	      SOTA/POTA
	    </button>
	    <div class="dropdown-menu">
	      <a class="dropdown-item" href="javascript:onProgChange(0);"><small>SOTA/POTA</small></a>
	      <a class="dropdown-item" href="javascript:onProgChange(1);"><small>SOTA</small></a>
	      <a class="dropdown-item" href="javascript:onProgChange(2);"><small>POTA</small></a>
	    </div>
	  </div>
	  <div class="dropdown">
	    <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false" id="period_dropdown">
	      Last 6H
	    </button>
	    <div class="dropdown-menu">
	      <a class="dropdown-item" href="javascript:onPeriodChange(1);"><small>1</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(3);"><small>3</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(6);"><small>6</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(9);"><small>9</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(12);"><small>12</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(15);"><small>15</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(18);"><small>18</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(21);"><small>21</small></a>
	      <a class="dropdown-item" href="javascript:onPeriodChange(24);"><small>24</small></a>
	    </div>
	  </div>
	  <div class="custom-control custom-checkbox">
	    <input class="custom-control-input" type="checkbox" value="" id="by_call" onclick="clickPrefs();refresh_spots()">
	    <label class="custom-control-label" for="by_call"><small>By Callsign</small></label>
	  </div>
	  <small><span id="clock_time2" style="cursor: default;" ></span></small>
	</div>
	<div id="chart-container" class="modal-body">
	  <canvas id="myChart"></canvas>
	</div>
      </div>
      <div class="modal-footer">
	<button type="button" class="btn btn-default" data-dismiss="modal" onclick="closePrefs()">Close</button>
      </div>
    </div>
  </div>
  
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
	<div id="map"></div>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-prefs" tabindex="-1" role="dialog" aria-labelledby="staticModalLabel" aria-hidden="true" data-show="true" data-keyboard="false" data-backdrop="static">
    <div class="modal-dialog">
      <div class="modal-content">
	<div class="modal-header">
          <h4 class="modal-title"><b>Preferences</b></h4>
	</div><!-- /modal-header -->
	<div class="modal-body">
	  <form>
	    <div class ="form-group">
	      <label class="control-label"><u>表示対象</u></label>
	      <div class="custom-control custom-checkbox">
		<input class="custom-control-input" type="checkbox" value="" id="sota_ref" onclick="clickPrefs()">
		<label class="custom-control-label" for="sota_ref">SOTA</label>
	      </div>
	      <div class="custom-control custom-checkbox">
		<input class="custom-control-input" type="checkbox" value="" id="pota_ref" onclick="clickPrefs()">
		<label class="custom-control-label" for="pota_ref">POTA</label>
	      </div>
  	      <div class="custom-control custom-checkbox">
		<input class="custom-control-input" type="checkbox" value="" id="jaff_ref" onclick="clickPrefs()">
		<label class="custom-control-label" for="jaff_ref">JAFF</label>
	      </div>
  	      <div class="custom-control custom-checkbox">
		<input class="custom-control-input" type="checkbox" value="" id="aprs_track" onclick="clickPrefs()">
		<label class="custom-control-label" for="aprs_track">SOTA APRS</label>
	      </div>
  	      <div class="custom-control custom-checkbox" id="check-pilgrim" style="diplay:none">
		<input class="custom-control-input" type="checkbox" value="" id="pilgrim" onclick="clickPrefs()">
		<label class="custom-control-label" for="pilgrim">観音霊場</label>
	      </div>
	    </div>
	    <div class ="form-group">
	      <label class="control-label"><u>マーカ</u></label>
	      <p>表示する数:&nbsp&nbsp<b>多</b>&nbsp&nbsp&nbsp
		<input id="zoom-threshold" data-slider-id='ex1Slider' type="text" data-slider-min="9" data-slider-max="12" data-slider-step="1" data-slider-value="12"/>&nbsp&nbsp&nbsp&nbsp<b>少</b>
	      </p>
	      <div class="custom-control custom-checkbox">
		<input class="custom-control-input" type="checkbox" value="" id="popup_permanent" onclick="clickPrefs()">
		<label class="custom-control-label" for="popup_permanent"> 公園名を常に表示</label>
	      </div>
	      <div class="custom-control custom-checkbox">
		<input class="custom-control-input" type="checkbox" value="" id="link_googlemap" onclick="clickPrefs()">
		<label class="custom-control-label" for="link_googlemap"> Google Mapにリンク</label>
	      </div>
	      <div class="custom-control custom-checkbox">
		<input class="custom-control-input" type="checkbox" value="" id="display_mapcode" onclick="clickPrefs()">
		<label class="custom-control-label" for="display_mapcode"> MAPCODEを表示<br><small>(「マップコード」および「MAPCODE」は㈱デンソーの登録商標です)</small></label>
	      </div>
	    </div>
	    <div class="form-group" id="check-pemuact" style="display:block">
	      <label class="control-label"><u>パドルエミュレータ</u></label>
	      <div class="custom-control custom-checkbox" id="check">
		<input class="custom-control-input" type="checkbox" value="" id="enable_emulation">
		<label class="custom-control-label" for="enable_emulation">使用する</label>
	      </div>
	      <table>
		<tr>
		  <td>
		    <div class="custom-control custom-checkbox">
		      <input class="form-check-input" type="radio" name="enable_wifi" id="enable_wifi">
		      <label class="form-check-label" for="enable_wifi">
			Host:
		      </label>
		    </div>
		  </td>
		  <td><input type=text id="pemu_host" size="16"></td>
		</tr>
		<tr>
		  <td>
		    <div class="custom-control custom-checkbox">
		      <input class="form-check-input" type="radio" name="enable_wifi" id="enable_serial">
		      <label class="form-check-label" for="enable_serial">
			シリアル
		      </label>
		    </div>
		  </td>
		</tr>
	      </table>
	    </div>
	    <div class="form-group">
	      <label class="control-label"><u>POTAログ表示</u></label>
	      <button type="button" class="btn btn-info btn-sm" data-toggle="modal" data-target="#logs-data" title="登録ログ数"><span class="fas fa-chart-bar"></span></button>
	      <div class="custom-control custom-checkbox">
		<input type="checkbox" class="custom-control-input" value="" id="show_potalog" onclick="clickPrefs()">
		<label class="custom-control-label" for="show_potalog"> POTAログを表示</label>
	      </div>
	      <div class="custom-control custom-checkbox">
		<input type="checkbox" class="custom-control-input" value="" id="enable_mqtt" onclick="clickPrefs(); potaLog('check');">
		<label class="custom-control-label" for="enable_mqtt"> MQTT連携</label>
	      </div>
	      <div class="custom-file">
		<input type="file" accept=".csv" style="width:10em"
		       class="custom-file-input" id="file_input" name="filename" required>
		<label class="custom-file-label" id="file_input_text" for="filename">POTA Logファイルを選択</label>
		<div class="invalid-feedback">ファイルを指定してください</div>
	      </div>
	      <div class="input-group">	      
		<button type="button" class="btn btn-default" onclick="potaLog('upload')">Upload</button>
		<button type="button" class="btn btn-default" onclick="potaLog('import')">IMPORT</button>
		<div class="input-group:append">
		  <input type="text" class="form-control-sm" style="width:6em" id="import_uuid">
		  <button type="button" id="export_uuid" class="btn btn-default" onclick="potaLog('export')">EXPORT</button>
		  <label class="form-check-label" for="export_uuid">
		    <div id="pota_export_key">XXXXXX</div>
		  </label>
		</div>
	      </div>
	      <div class="custom-control custom-checkbox">
		<input class="form-check-input" type="radio" name="potalog_type" id="show_potaactlog" onclick="potaLog('show-act')">
		<label class="form-check-label" for="show_potaactlog">
		  <div id="pota_activator_uuid">-</div>
		</label>
		<button type="button" id="activator-log" class="btn btn-warning" onclick="potaLog('del-act')">DEL </button>
	      </div>
	      <div class="custom-control custom-checkbox">
		<input class="form-check-input" type="radio" name="potalog_type" id="show_potaactlog2" onclick="potaLog('show-hunt')">
		<label class="form-check-label" for="show_potaactlog2">
		  <div id="pota_hunter_uuid">-</div>
		</label>
		<button type="button" id="hunter-log" class="btn btn-warning" onclick="potaLog('del-hunt')">DEL</button>
	      </div>
	    </div>
	  </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal" onClick="closePrefs()">Close</button>
          </div>
	</div> <!-- /.modal-body -->
      </div> <!-- /.modal-content -->
    </div> <!-- /.modal-dialog -->
  </div>

  <div class = "modal fade" id="logs-data">
    <div class="modal-dialog">
      <div class="modal-content">
	<div id="stat-container" class="modal-body">
	  <canvas id="myLogStat"></canvas>
	</div>
	<small><span id="perf_mon" style="cursor: default;" ></span></small>
      </div>
      <div class="modal-footer">
	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>

  <div class = "modal fade" id="pemuact">
    <div class="modal-dialog">
      <div class="modal-content">
	<div class="modal-header">
	  <h4 class="modal-title"><b>ActPaddle</b></h4>
	</div><!-- /modal-header -->
	<div id="keyer-container" class="modal-body">
	  <h4><bf><div id="pemu_name"></div></bf></h4>
	  <div class="table-responsive">
 	    <table>
	      <tr>
		<td> CALL:</td>
		<td><input type=text id="pemu_call" size="10"></td>
		<td>/</td>
		<td><input type=text id="pemu_areacode" size="1"></td>
		<td>
		  <div class="custom-control custom-checkbox">
		    <input class="form-check-input" type="checkbox" name="include_areacode" id="include_areacode">
		  </div>
		</td>
		<td>JCC/JCG:</td>
		<td><input type=text id="pemu_century" size="10"></td>
	      </tr>
	    </table>
	    <table>
	      <tr>
		<td>SOTA:</td>
		<td><input type=text id="pemu_sota" size="10"></td>
		<td>POTA:</td>
		<td><input type=text id="pemu_pota" size="8"></td>
		<td>JAFF:</td>
		<td><input type=text id="pemu_jaff" size="10"></td>
	      </tr>
	    </table>
	    <table>
	      <tr>
		<td> 1. </td>
		<td><input type=text id="pemu_mesg1" size="44"></td>
		<td><button class="btn btn-primary" onClick="pemuPressed(1)">SEND</button></td>
	      </tr>
	      <tr>
		<td> 2. </td>
		<td><input type=text id="pemu_mesg2" size="44"></td>
		<td><button class="btn btn-primary" onClick="pemuPressed(2)">SEND</button></td>
	      </tr>
	      <tr>
		<td> 3. </td>
		<td><input type=text id="pemu_mesg3"  size="44"></td>
		<td><button class="btn btn-primary" onClick="pemuPressed(3)">SEND</button></td>
	      </tr>
	      <tr>
		<td> 4. </td>
		<td><input type=text id="pemu_mesg4" size="44"></td>
		<td><button class="btn btn-primary" onClick="pemuPressed(4)">SEND</button></td>
	      </tr>
	    </table>
	    <table>
	      <tr>
		<td>Speed:</td>
		<td><input type=text id="pemu_wpm" size="3"></td>
		<td>wpm</td>
		<td>
		  <div class="custom-control custom-checkbox">
		    <input class="form-check-input" type="radio" name="to_paddle" id="to_paddle" checked>
		    <label class="form-check-label" for="to_paddle">
		      Paddle
		    </label>
		  </div>
		</td>
		<td>
		  <div class="custom-control custom-checkbox">
		    <input class="form-check-input" type="radio" name="to_paddle" id="to_key">
		    <label class="form-check-label" for="to_key">
		      Straight
		    </label>
		  </div>
		</td>
 		<td>
		  <div class="custom-control custom-checkbox">
		    <input class="form-check-input" type="checkbox" name="paddle_reverse" id="paddle_reverse">
		    <label class="form-check-label" for="paddle_reverse">
		      Reverse Paddle
		    </label>
		  </div>
		</td>
	      </tr>
	    </table>
	  </div>
	</div>
      </div>
      <div class="modal-footer">
	<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
<!-- Optional JavaScript -->
<script>
var prefs =
    { 'popup_permanent': true,
      'display_mapcode': false,
      'link_googlemap': false, 
      'by_call': false,
      'sota_ref': true,
      'pota_ref': true,
      'jaff_ref': true,
      'aprs_track': true,
      'pilgrim': false,
      'show_potalog': false,
      'show_potaactlog': true,
      'zoom_threshold': 12,
      'spot_period': 6,
      'pota_hunter_uuid': null,
      'pota_activator_uuid': null,
      'enable_mqtt': false,
      'enable_emulation': false,
      'pemu_call' : '',
      'pemu_areacode': '',
      'pemu_century': '',
      'pemu_sota' : '',
      'pemu_pota' : '',
      'pemu_jaff' : '',
      'pemu_mesg1': 'CQ CQ CQ DE $CALL SOTA $SOTA +',
      'pemu_mesg2': 'CQ CQ CQ DE $CALL POTA $POTA +',
      'pemu_mesg3': 'CQ CQ CQ DE $CALL JAFF $JAFF +',
      'pemu_mesg4': 'p 1#CQ CQ CQ DE $CALL SOTA $SOTA+',
      'pemu_wpm': '40',
      'pemu_host': 'actpaddle.local',
      'include_areacode': true,
      'paddle_reverse': false,
      'to_paddle' : true,
      'to_key' : false,
      'enable_wifi': false,
      'enable_serial': true,
    };

var enable_experimental = false;

if (location.host != 'mypilgrim.sotalive.net') {
    enable_experimental = false;
    document.getElementById('check-pilgrim').style.display = 'none';
}
else {
    enable_experimental = true;
    document.getElementById('check-pilgrim').style.display = 'block';
}

var tolerance;
if (navigator.userAgent.match(/iPhone|Android.+Mobile/)) {
    tolerance = 30;
} else {
    tolerance = 5;
}

let vh = window.innerHeight * 0.01;
document.documentElement.style.setProperty('--vh', `${vh}px`);
window.addEventListener('resize',()=> {
let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
});

var sotalive = 'https://www.sotalive.net/';
if (use_yahoo_revgeocode) {
    gsi_attribution = "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>|<a href='https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A10-v4_1.html' target='_blank'>国土数値情報自然公園地域データ</a>|<a href='https://developer.yahoo.co.jp/sitemap/'>Web Services by Yahoo! JAPAN</a>"
} else {
    gsi_attribution = "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>地理院タイル</a>|<a href='https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A10-v4_1.html' target='_blank'>国土数値情報自然公園地域データ</a>"
}
var gsi = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {maxZoom:18, maxNativeZoom:18, attribution: gsi_attribution
});

var gsi_photo = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', {maxZoom:18, maxNativeZoom:18, attribution: gsi_attribution
});

var yamareco_summer = L.tileLayer('https://www.yamareco.com/modules/yamareco/include/get_tileimg.php?type=dot_summer&z={z}&y={y}&x={x}', {maxZoom:18, maxNativeZoom:16, attribution: "<a href='https://www.yamareco.com/' target='_blank'>ヤマレコ</a>"
});

var yamareco_winter = L.tileLayer('https://www.yamareco.com/modules/yamareco/include/get_tileimg.php?type=dot_winter&z={z}&y={y}&x={x}', {maxZoom:18, maxNativeZoom:16, attribution: "<a href='https://www.yamareco.com/' target='_blank'>ヤマレコ</a>"
});

var map = L.map('map',{
      renderer: L.canvas({ tolerance: tolerance}),
    layers: [ gsi ]
});

var baseLayerControls = {
    '地理院地形図': gsi,
    '全国最新写真': gsi_photo,
};
if (enable_experimental) {  
    var overlayLayerControls = {
	'ヤマレコみんなの足跡(登山道)': yamareco_summer,
	'ヤマレコみんなの足跡(雪山)': yamareco_winter,
    };
    L.control.layers(baseLayerControls, overlayLayerControls, {
	collapsed: true,
    }).addTo(map);
} else {
    L.control.layers(baseLayerControls, null, {
	collapsed: true,
    }).addTo(map);
};
  
L.control.scale().addTo(map);
L.control.zoomLabel().addTo(map);

var popup = L.popup();

var last_area = null;
var last_mesg = '';
var geomagindex = 'A:-- K:-';


 function replacePOTAref(oldref) {
     return oldref.replace('JA-','JP-');
 }
  
function redrawPopup() {
    if (last_area != null) {
	var ctnt = '<b>' + selectRef(last_area, true) + '</b>' + last_mesg;
	popup.setContent(ctnt);
	popup.update();
    }
}

function locURI(lat, lng, zoom) {
    var gsiuri= 'https://maps.gsi.go.jp/',
	googleuri = 'https://www.google.com/maps/@?api=1&map_action=map&',
    	googleuri2 = 'https://www.google.com/maps/search/?api=1&query=';
    
    if (prefs['link_googlemap']) {
	var res =googleuri + 'center=' + lat + ',' + lng + '&zoom=' + zoom + '&basemap=satellite',
	    res2 =googleuri2 + lat + '%2C' + lng;

	return res2;
    } else {
	return gsiuri + '#' + zoom + '/' + lat + '/' + lng;
    }
}

async function potaLog(command){
    let keys = ['pota_activator_uuid','pota_hunter_uuid'];
    let res = null;
    let api = sotalive + 'api/myact/potalog?';
    
    switch(command) {
    case 'check':
	for(var k of keys) {
	    var el,mesg;
	    if (k == 'pota_hunter_uuid' && prefs['enable_mqtt']) 
		res = await fetch(api + 'command=CHECK' +
				  '&logid='+prefs[k]+
				  '&mqtt=1');
	    else
		res = await fetch(api + 'command=CHECK' +
				  '&logid='+prefs[k]);
	    res = await res.json();
	    if (res['errors'] == 'OK') {
		prefs[k] = res['uuid'];
		el = document.getElementById(k);
		if (k.includes('hunter')) {
		    mesg = '(Hunter)';
		} else {
		    mesg = '(Activator)';
		}
		el.innerText = res['create'] + mesg;
	    } else {
		prefs[k] = null;
		el = document.getElementById(k);
		el.innerText = '----';
	    }
	}
	closePrefs();
	break;

    case 'del-act':
	k = 0;
    case 'del-hunt':
	if (command.includes('hunt'))
	    k = 1;

	if (prefs[keys[k]] == null)
	    break;
	
	res = await fetch(api +'command=DELETE' +
			  '&logid='+prefs[keys[k]]);
	res = await res.json();
	if (res['errors'] == 'OK') {
	    prefs[keys[k]] = null
	    el = document.getElementById(keys[k]);
	    el.innerText = '----';
	    if (k == 0)
		potaLog('show-hunt');
	    else
		potaLog('show-act');
	}
	potaLog('check');
	break;

    case 'show-act':
	prefs['show_potalog'] = true;
	prefs['show_potaactlog'] = true;
	el = document.getElementById('show_potaactlog');
	el.checked = true;
	el = document.getElementById('show_potalog');
	el.checked = true;
	break;

    case 'show-hunt':
	prefs['show_potalog'] = true;
	prefs['show_potaactlog'] = false;
	el = document.getElementById('show_potaactlog2');
	el.checked = true;
	el = document.getElementById('show_potalog');
	el.checked = true;
	break;

    case 'upload':
	const file_input = document.getElementById('file_input');

	if (file_input.files.length == 0) {
	    window.alert("ファイルを指定してください");
	    return
	}
    
	const fd = new FormData();
	fd.append('uploadfile',file_input.files[0]);
	res = await fetch(api +'command=UPLOAD'+
			  '&logid_act='+prefs[keys[0]]+
			  '&logid_hunt='+prefs[keys[1]],{
			      method: 'POST',
			      body: fd
			  });
	res = await res.json();

	if (res['errors'] == 'OK') {
	    if (res['logtype'] == 'ACT') {
		prefs[keys[0]] = res['uuid'];
		potaLog('show-act');
	    }
	    else {
		prefs[keys[1]] = res['uuid'];
		potaLog('show-hunt');
	    }
	    potaLog('check');
	} else {
	    mesg =
		"不正なログファイルの形式です\n" +
		"POTA.appからダウンロードしたCSVファイルをアップロードして下さい";
	    window.alert(mesg);
	}
	break;

    case 'export':
	res = await fetch(api +'command=EXPORT' +
			  '&logid_act='+prefs[keys[0]]+
			  '&logid_hunt='+prefs[keys[1]]);
	res = await res.json();

	if (res['errors'] == 'OK') {
	    el = document.getElementById('pota_export_key');
	    el.innerHTML = '<b>' + res['sharekey'] + '</b>';
	} else {
	    window.alert("Exportに失敗しました")
	}
	break;

    case 'import':
	const sharekey = document.getElementById('import_uuid');
	res = await fetch(api +'command=IMPORT' +
			  '&sharekey='+ sharekey.value);
	res = await res.json();

	if (res['errors'] == 'OK') {
	    prefs[keys[0]] = res['uuid_act'];
	    prefs[keys[1]] = res['uuid_hunt'];
	    potaLog('check');

	    if (res['uuid_act'] != "null")
		potaLog('show-act')

	    if (res['uuid_hunt'] != "null")
		potaLog('show-hunt')

	} else {
	    window.alert("キーコードが見つかりません")
	}
	break;
	    
    default:
	console.log("Unknown command" + command);
	break;
    }
 }
 
  
function getLogID() {
    if (prefs['show_potaactlog'])
	return prefs['pota_activator_uuid'];
    else
	return prefs['pota_hunter_uuid']
}

function keyerButton(area) {
    let arg = '{';
    for (var k in area) 
	arg +=  k  + ':' + "'" + area[k] + "',";
    arg += '}'
    let bstr = '<center><button type="button" class="btn-outline-primary btn-sm" data-toggle="modal" data-target="#pemuact" onclick="clickPemuAct(' + arg + ')"><img src="svg/clipboard.svg"></button></center>';
    return bstr;
}


function clickPemuAct(area) {
    document.getElementById("pemu_name").innerText = area['name'];
    for(k in prefs) {
	if (k.includes('pemu')) {
	    let el = document.getElementById(k); 
	    if (prefs[k])
		el.value = prefs[k];
	    else
		el.value = "";
	}
    }
    if (area['sota_code'])
	document.getElementById("pemu_sota").value = area['sota_code'];
    else
	document.getElementById("pemu_sota").value = '';

    if (area['pota'])
	document.getElementById("pemu_pota").value = area['pota'];
    else
	document.getElementById("pemu_pota").value = '';

    if (area['jaff'])
	document.getElementById("pemu_jaff").value = area['jaff'];
    else
	document.getElementById("pemu_jaff").value = '';

    if (area['areacode'])
	document.getElementById("pemu_areacode").value = area['areacode'];
    else
	document.getElementById("pemu_areacode").value = '';

    if (area['century'])
	document.getElementById("pemu_century").value = area['century'];
    else
	document.getElementById("pemu_century").value = '';
}

var serial_port = undefined;
var serial_writer = undefined;
var serial_reader = undefined;

async function open_serial() {
    const filters = [
	{ usbVendorId: 0x303a, usbProductId: 0x1001 },
	{ usbVendorId: 0x0403, usbProductId: 0x6001 },
	{ usbVendorId: 0x1a86, usbProductId: 0x55d4 },
	{ usbVendorId: 0x10c4, usbProductId: 0xea60 },
    ];

    if (! "serial" in navigator) {
	window.alert("お使いのブラウザはシリアル通信が出来ません");
	return;
    }
    if (serial_port == undefined) {
	serial_port = await navigator.serial.requestPort({ filters });
	await serial_port.open({ baudRate: 115200 });
	const textEncoder = new TextEncoderStream();
	const writableStreamClosed = textEncoder.readable.pipeTo(serial_port.writable);
	serial_writer = textEncoder.writable.getWriter();
	serial_reader = serial_port.readable.getReader();
    }
}

async function pemuPressed(num) {
    clickPrefs();
    let msg = prefs["pemu_mesg"+String(num)].toUpperCase();
    let sota = prefs["pemu_sota"].replace('-','');
    let pota = prefs["pemu_pota"].replace('-','');
    let jaff = prefs["pemu_jaff"].replace('-','');
    let areacode = prefs["pemu_areacode"];
    let century = prefs["pemu_century"];
    let wpm = parseInt(prefs["pemu_wpm"], 10);
    let enable_wifi = prefs["enable_wifi"];
    let pemuuri = 'https://' + prefs["pemu_host"] + '/play';
    let jsonmsg = {};

    let call = prefs["pemu_call"];

    if (prefs["include_areacode"]&& areacode != "") 
	call += '/' + areacode;
    
    
    let replaced_msg =
	msg.toUpperCase()
	.replace('$CALL', call)
	.replace('$SOTA', sota)
	.replace('$POTA', pota)
	.replace('$JAFF', jaff)
        .replace('$JCC', century)
	.replace('$JCG', century)
    
    jsonmsg["wpm"] = wpm;

    if (prefs["to_paddle"])
	jsonmsg["to_paddle"] = replaced_msg;
    else
	jsonmsg["to_straight"] = replaced_msg;

    if(prefs["paddle_reverse"])
	jsonmsg["reverse"] = true;
    else
	jsonmsg["reverse"] = false;

    let jsonstr = JSON.stringify(jsonmsg) + '\r';

    if (navigator.clipboard) 
	navigator.clipboard.writeText(replaced_msg);

    if (enable_wifi) {
	console.log(pemuuri);
	await fetch(pemuuri, {
	    method: 'POST',
	    headers : {
		'Content-Type': 'applicatoin/json'
	    },
	    body: jsonstr
	})
	    .then((res) => {
		if (!res.ok) {
		    throw new Error(res.statusText);
		}
	    })
	    .catch((err) => {
		window.alert('接続エラー: '+pemuuri+' ('+err+')');});
    } else {
	await open_serial();
	try {
	    await serial_writer.write(jsonstr);
	} catch (err) {
	    window.alert('接続エラー: ブラウザをリロードしてください');
	};
	console.log(jsonstr);
	let {value, done} = await serial_reader.read();
	const v = new TextDecoder().decode(value);
	console.log(v);
    }
}

function displayPopup(area, latlng, isMarker, isGPS) {
    var lat = Math.round(latlng.lat * 1000000,4)/1000000,
	lng = Math.round(latlng.lng * 1000000,4)/1000000,
	z = map.getZoom();

    if ( z > 11)
	wz = 11
    else
	wz = z;

    var windyuri = 'https://www.windy.com/'+ latlng.lat + '/' + latlng.lng + '/meteogram?rain,' + latlng.lat + ',' + latlng.lng + ',' + wz ;

    if (isGPS) {
	Cookies.set('my_qth_lat',lat)
	Cookies.set('my_qth_lng',lng)
    }
    
    var query = '&programs=SOTAPOTA'+'&lat='+latlng.lat+'&lon='+latlng.lng+"&srange=200";

    if (area['pota']) {
	area['pota'] = replacePOTAref(area['pota']);
	query += "&parkid="+area['pota'];
    }
    if (prefs['show_potalog'])
	query += "&logid="+getLogID();
   
    fetch(sotalive+'api/myact/search?'+query)
	.then(res => res.json())
	.then(res => {
	    var sotamesg = '';
	    var potamesg = '';
	    var qsomesg = '';
	    if (res['errors'] == 'OK') {
		
		if (res['parks'].length > 0) {
		    p = res['parks'][0];
		    if (!('pota' in area))
			area['pota'] = p['pota'];
		    if (!('jaff' in area))
			area['jaff'] = p['jaff'];
		    if (!('name' in area))
			area['name'] = p['name_k'];
		    if (prefs['show_potalog']) {
			if (p['attempt'] > 0) { 
			    qsomesg = "<br>Activate/Attempt: "+p['activate'] + "/" + p['attempt']
			    qsomesg += "<br>QSOs: " + p['QSOs'] + "<br>";
			} else if (p['QSOs'] > 0)
			qsomesg = "<br>QSOs: " + p['QSOs'] + "<br>";
		    }
		}


		if (res['summits'].length >0) {
		    s = res['summits'][0]
		    area['sota_code'] = s['code'];
		    area['sota'] = s['code'] + ' ' +s['name'];
		    if (area['name'])
			area['name'] += ' / ' + s['name_k'];
		    else
			area['name'] = s['name_k'];

		    l = {'lat':s['lat'],'lng':s['lon']}
		    displayActivationZone(l, -0.8);
		    pos = '<br>位置:<a href="' + locURI(s['lat'], s['lon'], z) +
			'" target="_blank">'  + s['lat'] + ',' + s['lon'] +'</a>';
		    sotamesg = escapeStr(s['desc'])+ '<br>GL:' + s['maidenhead'] + pos + '<br>標高:'+ s['elev']+'m,'+s['pts']+'pts (+' + s['bonus'] +')';
		    qsomesg += '<br>Activations: ' + s['actcnt']
		    if (s['actcnt']!= 0)
			qsomesg += '<br>Last Activation: ' + s['lastact'] + '(' + s['lastcall'] + ')';
		}
	    };
	    local_reverse_geocoder(latlng.lat, latlng.lng, true)
		.then(res => {

		    if ('elevation' in res) {
			if ('alt' in latlng) {
			    altitude = res['elevation'] + 'm (GPS測位値:'+latlng.alt+'m)';
			} else {
			    altitude = res['elevation'] + 'm';	    
			}
		    } else
			altitude = '---';
		    
	    	    if (res['errors'] == 'OUTSIDE_JA') {
			mesg = 'Pos: ' + lat +','+ lng + '<br>GL: '+res['maidenhead'];
		    }
		    else if (res['errors'] != 'OK') {
 			mesg = 'Parameter out of range.';
		    } else {
			accu = '<small>[' + res['hsrc'].replace('（','').replace('）','') + ']</small>'
			
			if (isGPS)
			    pos = '<br>位置:<a href="' + locURI(lat, lng, z) +
			    '" target="_blank">' + lat + ',' + lng +'</a>';
			else
			    pos = '<i><br>位置:<a href="' + locURI(lat, lng, z) +
			    '" target="_blank">'  + lat + ',' + lng +'</a></i>';
			
			if (res['type'] == 'JCC') {
			    
			    if (res['ward'] != undefined) {
				area['century'] = 'JCC ' + res['ward'];
				mesg = 'JCC'+res['jcc']+ ' 区番号:' + res['ward'] + '<br>' +
				    res['pref'] + res['addr2'] + res['addr1'] + '<br>GL:' + res['maidenhead'] +
				    pos + '<br> 標高:' + altitude;
			    }
			    else {
				area['century'] = 'JCC ' + res['jcc']
				mesg = 'JCC'+res['jcc']+ '<br>' + res['pref'] + res['addr2'] + res['addr1'] +
				    '<br>GL:' + res['maidenhead'] + pos + '<br> 標高:' + altitude;}
			}
			else {
			    area['century'] = 'JCG ' + res['jcg'] + res['hamlog'];
			    mesg = 'JCG'+res['jcg']+ res['hamlog']+ '<br>' + res['pref'] + res['addr2'] +
				res['addr1']+ '<br>GL:' + res['maidenhead'] + pos + '<br> 標高:' + altitude;
			}
		    }

		    if (prefs['display_mapcode'] && res['mapcode']) 
			mapcode = '<br><img src="img/mc_long.jpg" height=14px> &nbsp' + res['mapcode'];
		    else
			mapcode = '';
		    
		    weather= '&nbsp&nbsp<a href="' + windyuri +
			'" target="_blank"><img src="svg/sun.svg"><img src="svg/cloud.svg"><img src="svg/rain.svg"></a>' +
			mapcode;

		    if ('areacode' in res && res['areacode'])
			area['areacode'] = res['areacode'][0];

		    if (sotamesg){
			if (isGPS)
			    mesg = sotamesg +'<br><b>現在地: </b>'+ mesg;
			else
			    mesg = sotamesg +'<br><b>クリック位置: </b>'+ mesg;
		    }
		    cnt = selectRef(area, true);
		    if (cnt != '') {
			cnt = '<b>' + cnt + '</b>' + mesg + weather + qsomesg;
			if (prefs["enable_emulation"])
			    cnt += keyerButton(area);
		    }
		    else
			cnt = mesg + weather;

		    popup.setLatLng(latlng)
			.setContent(cnt)
			.openOn(map);

		    if (isMarker && qth_marker != null)
			qth_marker.bindPopup(cnt).openPopup();

		    last_area = area;
		    last_mesg = mesg;
		});
	});
}


$('#zoom-threshold').slider({
    formatter: function(value) {
	prefs['zoom_threshold'] = Number(value);
	return '全ての公園を表示するズームレベル ' + value;
    }
});

$('#spot-period').slider({
    formatter: function(value) {
	prefs['spot_period'] = Number(value);
	return '最新' + value + "時間を表示";
    }
});
   
function clickPrefs() {
    for(var k in prefs) {
	if (k == 'zoom_threshold' || k == 'spot_period'||k.includes('uuid')) {
	    Cookies.set(k ,String(prefs[k]),
			{expires: 1800, SameSite:'Lax'});
	} else if (k.includes('pemu')) {
	    prefs[k] = document.getElementById(k).value;
	    Cookies.set(k ,prefs[k],{expires: 1800, SameSite:'Lax'});
	} else {
	    var el = document.getElementById(k);
	    if (el.checked == true) {
		prefs[k] = true;
		Cookies.set(k, 'true',{expires: 1800, SameSite:'Lax'})
	    } else {
		prefs[k] = false;
		Cookies.set(k, 'false',{expires: 1800, SameSite:'Lax'})
	    }
	}
    }
}

function readCookie(pref) {
    for (var k in pref) {
	var ck = Cookies.get(k);
	if (k == 'zoom_threshold') {
	    if (ck  == undefined) {
		ck = '12';
		Cookies.set(k, ck,{expires: 1800, SameSite:'Lax'});
	    }
	    else
		pref[k] = Number(ck)
	    $('#zoom-threshold').slider('setValue',Number(ck))
	}
	else if (k == 'spot_period') {
	    if (ck  == undefined) {
		ck = '6';
		Cookies.set(k, ck,{expires: 1800, SameSite:'Lax'});
	    }
	    else
		pref[k] = Number(ck)
	    $('#spot-period').slider('setValue',Number(ck))
	}
	else if (k.includes('uuid')) {
	    pref[k] = ck;
	} else if (k.includes('pemu')) {
	    if (ck)
		pref[k] = ck;
	    document.getElementById(k).value = pref[k];
	}
	else {
	    if (ck  == undefined) {
		if (pref[k])
		    Cookies.set(k, 'true',{expires: 1800, SameSite:'Lax'})
		else
		    Cookies.set(k, 'false',{expires: 1800, SameSite:'Lax'})
	    } else {
		if (ck == 'true')
		    pref[k] = true
		else
		    pref[k] = false
	    }
	    var el = document.getElementById(k);
	    if (pref[k])
		el.checked = true
	    else
		el.checked = false;
	}
    }
    
    if (pref['show_potaactlog'])
	potaLog('show-act')
    else
	potaLog('show-hunt')
    
    potaLog('check');
}

function closePrefs() {
    clickPrefs();
    redrawPopup();
    redrawMarkers();
    refresh_spots();
    refresh_aprs_track();
}

readCookie(prefs);

function selectRef(area, addhref) {
    var pname = '';
        
    if (area['pota'] != undefined && area['jaff'] != undefined) { 
	if (area['pota'] != '' && prefs['pota_ref']) {
	    if (addhref && area['pota'].includes('-')) 
		pname = '<a target="_blank" href="https://pota.app/#/park/'+ area['pota'] + '">' + area['pota'] + '</a> '
	    else
		pname = area['pota'];
	    if (area['jaff'] != '' && prefs['jaff_ref']) {
		if (addhref && area['jaff'].includes('-'))
		    pname += '/' + '<a target="_blank" href="https://wwff.co/directory/?showRef='+ area['jaff'] + '">' + area['jaff'] + '</a> '
		else 
		    pname += '/' + area['jaff'];
	    }
	} else if (prefs['jaff_ref']) {
	    if (addhref)
		pname = '<a target="_blank" href="https://wwff.co/directory/?showRef='+ area['jaff'] + '">' + area['jaff'] + '</a> '
	    else 
		pname = area['jaff']
	}
    } else if (area['temple'] != undefined && prefs['pilgrim']) {
	pname = area['temple']
    };

    if (area['sota']) {
	sname = '<a target="_blank" href="https://summits.sota.org.uk/summit/' + area['sota_code'] + '">' + area['sota'] + '</a>'

	if (pname == '')
	    pname = sname;
	else
	    pname = pname + ' ' + sname;
    }
    
    if (pname != '' && area['name'] != '') {
	pname += '<br>'
	pname += area['name'];
    }
    
    if (pname != '')
	pname = '<div style="text-align:center">' + pname + '</div>';

    return pname;
}
   
qth_marker = null

function QTHdragend(e) {
    var latlng = e.target.getLatLng();
    map.setView(latlng, 15); 
    displayPopup({}, latlng, true, false);
}

function callbkQTHOk(arg) {
    var crd = arg.coords;
    var latlng = [crd.latitude, crd.longitude],
	options = {
        prefix: 'icon'
        ,icon: 'user'
        ,shape: 'circle'
        ,markerColor: 'yellow'
        ,extraClasses: 'semantic-ui-custom'
	};

    if (false && crd.altitude != null) {
	r_alt = Math.round(crd.altitude*100)/100;
	gps_pos = {lat:crd.latitude, lng:crd.longitude, alt:r_alt };
    }
    else
	gps_pos = {lat:crd.latitude, lng:crd.longitude};

    map.setView(latlng, 15);

    if (qth_marker != null)
	map.removeLayer(qth_marker)
	    
    qth_marker = L.marker(latlng,
			  {draggable:true, icon: L.ExtraMarkers.icon(options)});

    qth_marker.addTo(map);
    displayPopup({}, gps_pos , true, true);
    qth_marker.on('dragend', QTHdragend);
};

function callbkQTHNG(arg) {
    var emsg = "エラーが発生しました",
	lat = Cookies.get('my_qth_lat'),
	lng = Cookies.get('my_qth_lng'),
	zoom = 13;

    switch(arg.code) {
    case 1:
	emesg = "位置情報の利用が許可されていません";
	break;
    case 2:
	emesg = "端末位置がわかりませんでした";
	break;
    case 3:
	emesg = "タイムアウトしました";
	break;
    }
    window.alert(emesg);

    if (lat) 
	latlng = [ parseFloat(lat), parseFloat(lng)];
    else {
	latlng = [37.514444, 137.712222];
	zoom = 6;
    };
    map.setView(latlng, zoom);
};

function clickQTHButton () {
    if (typeof navigator.geolocation === 'undefined') {
	console.log("navigator.gelocation unsupported");
	window . alert('ブラウザが位置情報取得に対応していません');
	map.setView([37.514444, 137.712222], 6);
    }

    var options = {
	"enableHighAccuracy": true,
	"timeout": 10000,
	"maximumAge": 0
    }
    navigator.geolocation.getCurrentPosition(callbkQTHOk, callbkQTHNG, options);
};

function kp_index() {
    fetch(sotalive + "api/geomag")
	.then(res => res.json())
	.then(geomag=> {
	    kp = geomag.Kp[0];
	    ap = geomag.Ap;
	    geomagindex = 'A:'+ap +' K:' +kp;
	});
}

function clock() {
    var now = new Date();
    var tm = now.toString();
    tm  = tm.replace(/:\d{2} GMT\+.+/,'');
    var tm2 =`${now.getFullYear().toString().slice(-2)}/${("00"+(now.getMonth()+1).toString()).slice(-2)}/${("00"+now.getDate().toString()).slice(-2)} ${("00"+now.getHours().toString()).slice(-2)}:${("00"+now.getMinutes().toString()).slice(-2)}`;
    var tm3 =`${("00"+(now.getMonth()+1).toString()).slice(-2)}/${("00"+now.getDate().toString()).slice(-2)} ${("00"+now.getHours().toString()).slice(-2)}:${("00"+now.getMinutes().toString()).slice(-2)}`; 

    document.getElementById("clock_time").innerHTML='&nbsp'+ tm2 + '&nbsp' + geomagindex;
    document.getElementById("clock_time2").innerHTML='&nbsp'+ tm3;
}

function escapeStr(str) {
    var escstr;
    if (!str)
	escstr = ""
    else
	escstr = str
    var replacement = [[/&/g, "&amp;"],[/</g, "&lt;"],[/>/g, "&gt;<br>"],[/"/g, "&quot;"]]
    for(var e in replacement)
	escstr = escstr.replace(replacement[e][0],replacement[e][1]);
    escstr = escstr.replace(/<br>$/,'');
    return escstr;
}

var show_summit_marker = [];
   
function deleteSummitMarker() {
    while (show_summit_marker.length > 0) {
	var m = show_summit_marker.pop()
	map.removeLayer(m)
    }
}

var _popupMarker = null

function clearSummitMarker() {
    userChange = true
    _popupMarker = null
}

function popupSummitMarker(latlng) {
    userChange = true
    _popupMarker = latlng
}

function placeSummitMarkers(nw ,se, z) {
    var popup,elev,prefix,level,query,programs,uuid;

    if (z >= prefs['zoom_threshold']) {
	elev = 0;
	level = 0;
    }
    else if (z > 9) {
	elev = 800;
	level = 1;
    }
    else if (z > 8) {
	elev = 1000;
	level = 10;
    }
    else if (z > 6) {
	elev = 1500;
	level = 20;
    }
    else {
	elev = 4000;
	level = 30;
    }

    programs = 'JAFFPOTA';
    if (prefs['sota_ref'])
	programs += 'SOTA';

    if (enable_experimental && prefs['pilgrim'])
	programs += 'PILGRIM';

    if (prefs['show_potalog']) {
	uuid = getLogID();
	query = '&programs='+programs+'&lat='+nw[0]+
	    '&lon='+nw[1]+'&lat2='+se[0]+'&lon2='+se[1]+
	    '&elevation='+elev+'&parkarea='+level+'&logid='+uuid;
    } else
	query = '&programs='+programs+'&lat='+nw[0]+
	'&lon='+nw[1]+'&lat2='+se[0]+'&lon2='+se[1]+
	'&elevation='+elev+'&parkarea='+level;
    
    
    fetch(sotalive+'api/myact/search?'+query)
	.then(res => res.json())
	.then(res => {
	    if (res['errors'] != 'OK') {
		return;
	    }
	    if (z > 11)
		wz = 11
	    else
		wz = z;
	    if (prefs['sota_ref'])
		for(const s of res['summits']) {
		    popup = false
		    if (_popupMarker &&
			s['lat'] == _popupMarker[0] &&
			s['lon'] == _popupMarker[1]) {
			popup = true
			_popupMarker = null
		    }
		    show_summit_marker.push(
			placeSummitMarker([s['lat'],s['lon']], z, s['elev'], s['actcnt'], popup))
		
		}
	    for(const s of res['parks']) {
		
		var pname = selectRef({'pota':s['pota'],
				       'jaff':s['jaff'],
				       'name':s['name_k']}, false);
		if (pname != '')
		    show_summit_marker.push(
			placeParkMarker([s['lat'],s['lon']], z, s))
	    }
	    for(const t of res['temples']) {
		show_summit_marker.push(
		    placeTempleMarker([t['lat'],t['lon']], z, t))
	    }
	});
}

function placeSummitMarker(coords, z, elev, actcnt, popupfl) {

    var rad;
    if (z > 14)
	rad = 10
    else if (z > 12)
	rad = 8
    else if (z > 10)
	rad = 6
    else
	rad = 4

    var fillc,
	border = "#4e342e"

    if (elev > 1500)
	fillc ="#c62828"
    else if (elev > 1100)
	fillc = "#ef6c00"
    else if (elev > 850)
	fillc = "#f9a825"
    else if (elev > 650)
	fillc = "#9e9d24"
    else if (elev > 500)
	fillc = "#558b2f"
    else
	fillc = "#1b5e20"
    
    var marker =
	L.circleMarker(coords,
		       {color: border,
			fillColor: fillc,
			radius:rad,
			weight:2,
			fillOpacity:0.8,
			opacity:1
		       });
    if (z > 11) {
	marker.bindTooltip(String(actcnt),
			   {permanent: true, direction: 'center', className: 'my-tooltip-label',offset:[0,0]})
    }
    var m = marker.addTo(map);
    
    m.on('click',function(e) {
	var l = e['target']['_latlng'];
	L.DomEvent.stopPropagation(e);
	displayPopup({}, l , false, false);
    });
    return m;

}

function placeParkMarker(coords, z,  parks) {

    if (parks['date']!=null) {
	if (parks['locid'].length == 1) {
	    if (!prefs['show_potaactlog']||parks['activate'] > 0)
		markerColor = 'red';
	    else
		markerColor = 'yellow'
    }
	else
	    markerColor = 'orange';
    } else {
	markerColor = 'green-light';
    }
    
    var options = {
        prefix: 'icon'
        ,icon: 'tree'
        ,shape: 'square'
        ,markerColor: markerColor
        ,extraClasses: 'semantic-ui-custom'
    }, area = {
	pota : replacePOTAref(parks['pota']),
	jaff : parks['jaff'],
	name : parks['name_k']
    };
	
    var marker = L.marker(coords,{icon:L.ExtraMarkers.icon(options)}),
	mesg1 = selectRef(area, false),
	mesg2 = selectRef(area, true);
    
    marker.bindTooltip(mesg1,
		       {permanent: prefs['popup_permanent'], direction: 'center',offset:[0,20]})
    var m = marker.addTo(map);
    m.on('click',function(e) {
	displayPopup(area, e.latlng, false, false)
    });
    return m;
}

function placeTempleMarker(coords, z,  temple) {
    markerColor = 'orange';
    var options = {
        prefix: 'icon'
        ,icon: 'leaf'
        ,shape: 'square'
        ,markerColor: markerColor
        ,extraClasses: 'semantic-ui-custom'
    }, area = {
	temple: temple['site_no'] + ' ' + temple['sacredplace'],
	name : temple['name']
    };
	
    var marker = L.marker(coords,{icon:L.ExtraMarkers.icon(options)});
    
    marker.bindTooltip(temple['site_no'] + ' ' + temple['name'],
		       {permanent: prefs['popup_permanent'], direction: 'center',offset:[0,20]})
    var m = marker.addTo(map);
    m.on('click',function(e) {
	displayPopup(area, e.latlng, false, false)
    });
    return m;
}

function showReference(s) {
    latlng = s['coord']
    
    map.setView(latlng,15);
    if (s['code'].match(/JA\d*\/.+/)) {
	displayPopup({},{'lat':s['coord'][0],'lng':s['coord'][1]},false, false);
    }
    redrawMarkers();
}

L.TopoJSON = L.GeoJSON.extend({
    addData: function (data) {
        var geojson, key;
        if (data.type === "Topology") {
            for (key in data.objects) {
		if (data.objects.hasOwnProperty(key)) {
                    geojson = topojson.feature(data, data.objects[key]);
                    L.GeoJSON.prototype.addData.call(this, geojson);
		}
            }
            return this;
        }
        L.GeoJSON.prototype.addData.call(this, data);
        return this;
    }
});

L.topoJson = function (data, options) {
    return new L.TopoJSON(data, options);
};

var geojson = L.topoJson(null, {
    style: function(feature){
        return {
	    color: "#000",
	    opacity: 1,
	    weight: 1,
	    fillColor: '#9fa8da',
	    fillOpacity: 0.3
        };
    },
    onEachFeature: function(feature, layer) {
	layer.on('click', function(e) {
	    displayPopup({'pota':feature.properties.POTA,
			  'jaff':feature.properties.JAFF,
			  'name':feature.properties.NAME,
			 },
			 e.latlng, false, false);
	    L.DomEvent.stop(e);
	});
	layer.on('contextmenu', function(e) {
	    displayPopup({'pota':feature.properties.POTA,
			  'jaff':feature.properties.JAFF+'('+feature.properties.PID+','+feature.properties.UID+')',
			  'name':feature.properties.NAME,
			 },
			 e.latlng, false, false);
	    L.DomEvent.stop(e);
	});
    }
});


geojson.addTo(map);
kp_index();
setInterval(kp_index,1000*1800);
clock();
setInterval(clock,5000);

async function getGeoData(url) {
    let response = await fetch(url);
    let data = await response.json();
    return data;
}

getGeoData('json/jaffpota-annotated-v21.json').then(data => geojson.addData(data));

userChange = true;

map.on('click', function(e) {
    displayPopup({}, e.latlng, false, false);
});

map.on('dragend',function(e) {
    userChange = true
})

map.on('zoomend',function(e) {
    userChange = true
})

function placeHamFairMarker(coord) {
    var options = {
        prefix: 'icon'
        ,icon: 'star'
        ,shape: 'square'
        ,markerColor: 'pink'
	,riseOnHover: true
        ,extraClasses: 'semantic-ui-custom'
    },
	area = {
	pota : 'Ham Fair 2023',
	jaff : '',
	name : 'ハムフェア2023'
    };

    var marker = L.marker(coord,{icon:L.ExtraMarkers.icon(options)});
    marker.bindTooltip('<b><a href="https://www.jarl.org/Japanese/1_Tanoshimo/1-3_Ham-Fair/2023/Ham-Fair-yoko.htm" target="_blank">Ham Fair 2023</a></b>',{permanent: prefs['popup_permanent'], direction: 'center',offset:[0,20],interactive:true})
    var m = marker.addTo(map);
    m.on('click',function(e) {
	displayPopup(area, coord, false, false)
    });
}

function redrawMarkers() {
    deleteSummitMarker();
    var z = map.getZoom();
    var b = map.getBounds();
    placeSummitMarkers([b['_northEast']['lat'], b['_southWest']['lng']],
		       [b['_southWest']['lat'], b['_northEast']['lng']],z);
    //placeHamFairMarker({'lat':35.627288040687716, 'lng':139.79562967407333});
}
       
map.on('moveend',function(e) {
    if (userChange) {
	userChange = false;
	redrawMarkers();
    }
});

clickQTHButton();

//Latest Spot Chart
const plugin = {
    id: 'customCanvasBackgroundColor',
    beforeDraw: (chart, args, options) => {
	const {ctx} = chart;
	ctx.save();
	ctx.globalCompositeOperation = 'destination-over';
	ctx.fillStyle = options.color || '#99ffff';
	ctx.fillRect(0, 0, chart.width, chart.height);
	ctx.restore();
    }
};

var chart = null;
var chart2 = null;
var prevloc = null;
var target_prog = ['pota', 'sota'];

function locate_ref(loc) {
    if (loc != prevloc) {
	let url = 'https://www.sotalive.net/api/sota-jaff-pota?refid='+loc;
	fetch(url)
	    .then(res => res.json())
	    .then(data=> {
		let r = data['reference'][0];
		showReference({
		    coord:[r['lat'], r['lon']],
		    name: r['name'],
		    code: r['code'],
		})
	    });
	prevloc = loc;
    }
}

function label_callback(item, data){
    locate_ref(item.raw['ref']);
    return item.raw['z'];
}

function onProgChange(prog) {
    let drop = document.getElementById('program_dropdown');
    let prev_prog = target_prog;
    
    if (prog == 0) {
	drop.textContent = 'SOTA/POTA';
	target_prog = ['pota','sota'];
	
    } else if (prog == 1) {
	drop.textContent = 'SOTA';
	target_prog = ['sota'];

    } else if (prog == 2) {
	drop.textContent = 'POTA';
	target_prog = ['pota'];
    }
    if (prev_prog != target_prog) {
	refresh_spots();
    } 

}

function onPeriodChange(p) {
    let drop = document.getElementById('period_dropdown');
    drop.textContent = 'Last '+String(p) + 'H';
    if (prefs['spot_period'] != p) {
	prefs['spot_period'] = p;
        closePrefs();
    }
}

async function stat_db() {
    let url = 'https://www.sotalive.net/api/myact/potalog?command=STAT';
    let res = await fetch(url);
    let hist = await res.json();

    let ctx = document.getElementById('myLogStat').getContext('2d');
    let cnt = document.getElementById('stat-container');

    ctx.canvas.height= 320;
    cnt.style.height = ctx.canvas.height + 40;
    ctx.canvas.width= 320;
    cnt.style.width = ctx.canvas.width + 40;

    let labels = []
    let users = []
    let logsizes = []
    
    for (const l of hist['log_history']) {
	labels.push(new Date(l['time']));
	users.push(l['users']);
	logsizes.push(l['logs']);
    };

    if (chart2) {
	chart2.destroy();
    }
    
    chart2 = new Chart(ctx, {
	data: {
	    labels : labels,
	    datasets:[
		{
		    type: 'bar',
		    label: 'Uploaded logs',
		    data: users,
		    borderColor : "rgba(254,97,132,0.8)",
		    backgroundColor : "rgba(254,97,132,0.5)",
		    yAxisID: "y",},
		{
		    type: 'bar',
		    label: 'Total log entries',
		    data: logsizes,
		    borderColor : "rgba(54,164,235,0.8)",
		    backgroundColor : "rgba(54,164,235,0.5)",
		    yAxisID: "y1",}
		]
	},
	options: {
	    responsive: true,
	    scales: {
		x: {
		    type: 'time',
		    time: {
			unit: 'day',
			stepsize: 1,
			displayFormats:{
			    'day': 'MM/dd',
			},
		    },
		},

		y:{
		    display: true,
		    position: 'left',
		    stepSize: 10,
		},
		y1:{
		    display: true,
		    position: 'right',
		    stepSize: 1000,
		     grid: {
			 drawOnChartArea: false,
		     },
		},
	    }
	},
    });
    chart2.update();
    let etime = "Query with "+ hist['longest_entry'] + "entries took "+hist['query_elapsed_ms'] + "ms. (degraded " + hist['query_perf_degrade_ms'] + "ms)"; 
    document.getElementById("perf_mon").innerHTML= etime;
}


var aprs_layer = null;
function drawAPRSTrack(prop, track) {
    let coords = track['coordinates'],
	ssid = prop['ssid'],
	callsign = prop['callsign'],
	lastseen = new Date(prop['lastseen']),
	distance = prop['distance'],
	summit = prop['summit'],
	spot_summit = prop['spot_summit']
	spot_time = prop['spot_time'],
	spot_freq = prop['spot_freq'],
	spot_mode = prop['spot_mode'],
    	spot_comment = prop['spot_comment'];

    let actopt = {month:"numeric",day:"numeric",
		  hour:"numeric", minute:"numeric"},
	spotopt = {hour:"numeric", minute:"numeric"};
    
    lastseen = lastseen.toLocaleString('en-us', actopt);
    
    if (spot_time) {
	spot_time = new Date(spot_time);
	spot_time = spot_time.toLocaleString('en-us', spotopt);
    } else
	spot_time = "";
    
    L.polyline(coords, {color:'#0d47a1', opacity:0.4, weight:4}).addTo(aprs_layer);
    
    for (const latlng of coords) 
	L.circleMarker(latlng, {color:'#ff1744', radius:2}).addTo(aprs_layer)

    if (ssid == '5' || ssid == '7') {
	options = {
            prefix: 'icon'
            ,icon: 'user outline'
            ,shape: 'star'
            ,markerColor: 'yellow'
            ,extraClasses: 'semantic-ui-custom'
        };
    }
    else if (ssid == '9') {
 	options = {
            prefix: 'icon'
            ,icon: 'car'
            ,shape: 'star'
            ,markerColor: 'yellow'
            ,extraClasses: 'semantic-ui-custom'
        };
    } else {
 	options = {
            prefix: 'icon'
            ,icon: 'home'
            ,shape: 'star'
            ,markerColor: 'yellow'
            ,extraClasses: 'semantic-ui-custom'
        };
    }

    let marker = L.marker(coords[coords.length-1],
			  { icon: L.ExtraMarkers.icon(options) });
    let message = '<b>' + lastseen + ' ' + callsign + ' (' + distance + 'm from ' + summit + ')</b>';

    if (spot_time && parseInt(distance) < 500)
	message += '<br><center>' + spot_time + ' ' + spot_freq + ' ' + spot_mode + ' ' + spot_summit + '<br>' +  spot_comment +'</center>'
	
    marker.bindPopup(message).openPopup();
    marker.addTo(aprs_layer);
}
  
async function refresh_aprs_track() {

    if (prefs['aprs_track']) {
	if (aprs_layer) {
	    map.removeLayer(aprs_layer);
	    aprs_layer =  L.layerGroup();
	} else
	    aprs_layer =  L.layerGroup();
    } else {
	if (aprs_layer)
	    map.removeLayer(aprs_layer);
	return;
    }

    map.addLayer(aprs_layer);
    
    let range = '24';
    let api = sotalive + 'api/aprs-tracklog/tracks?region=JA&range='+ range;

    let res = await fetch(api);
    res = await res.json();
    let tracks = res['tracks'];
    for (const track of tracks) {
	drawAPRSTrack(track['properties'],track['geometry']);
    }
}
    
async function refresh_spots() {
    let api = sotalive + 'api/myact/potalog?command=SPOTS&region=JA%2CJP';
    if (prefs['pota_hunter_uuid'] != null) {
	api += '&logid=' + prefs['pota_hunter_uuid'];
    }
    if (prefs['by_call']) {
	api += '&bycall=1';
    }
    api += '&period=' + String(prefs['spot_period']);

    let res = await fetch(api);
    res = await res.json();
    let sdata = res['spots'];
    let logs = res['logs'];
    let datasets = [];
    let radius = 0;
    let rc = 0;

    for(let prog of target_prog) {
	let data = sdata[prog]

	if (data == null)
	    continue;
	
	let refs = Object.keys(data);
	let rspots = Object.values(data);
	
	for(var i = 0; i < refs.length; i++) {
	    let ref = refs[i];
	    let spots = rspots[i];
	    let sp =[];
		    
	    for (const p of spots) {
		if (prefs['by_call'])
		    r = p[1];
		else
		    r = ref;
		sp.push(
		    { x : new Date(p[0]),
		      y: rc,
		      z: ref+" "+p[1]+" "+p[2]+" "+p[3]+" "+ p[4],
		      ref: r,
		    })
	    }
	    
	    if (prefs['by_call']||prog == 'sota'||
		!prefs['show_potalog']||
		(ref in logs && logs[ref].length == 1)) {
		d = {label: ref,
		     pointRadius: 5,
		     data:sp};
	    }
	    else { 
		d = {label: ref,
		     pointRadius: 8,
		     pointBoderWidth:4,
		     data:sp};
	    }
	    datasets.push(d)
	    rc += 1;
	}
    }
    let ctx = document.getElementById('myChart').getContext('2d');
    let cnt = document.getElementById('chart-container');
    
    ctx.canvas.height= rc * 20 + (rc/3 + 1) * 30;
    cnt.style.height = ctx.canvas.height + 40;
    
    if (chart) {
	chart.destroy();
    }
    let now = new Date();
    let spot_from = new Date(now.getTime()- prefs['spot_period'] * 1000 * 3600);
    let spot_to = new Date(now.getTime()+ 300 * 1000);
    
    chart = new Chart(ctx, {
	type: 'line',
	
	data: {
	    datasets: datasets
	},
	options: {
	    responsive: true,
	    maintainAspectRatio: false,
	    layout: {
		padding: {
		    left:20,
		    right:20,
		}
	    },
	    plugins: {
		legend: {
		    position: 'top',
		    reverse: true,
		},
		tooltip: {
		    backgroundColor :"rgba(19, 58, 95, 09)",
		    xPading:10,
		    yPadding:10,
		    callbacks: {
			label: label_callback,
			    },
		},
		customCanvasBackgroundColor:{
		    color: 'white',
		}
	    },
	    scales: {
		x: {
		    type: 'time',
		    time: {
			unit: 'hour',
			displayFormats:{
			    'hour': 'MM/dd HH:mm',
			},
		    },
		    max : spot_to,
		    min: spot_from,
		},
		y: {
		    display: false,
		},
	    }
	},
	plugins:[plugin],
    });
    chart.update();
}

onPeriodChange(prefs['spot_period']);

var aprs_timer_id = null;
var spot_timer_id = null;

  $('#spots-data').on('show.bs.modal', function(e) {
      refresh_spots();
      spot_timer_id = setInterval(refresh_spots,60000);
  });
  
  $('#spots-data').on('hide.bs.modal', function(e) {
      if (spot_timer_id)
	  clearInterval(spot_timer_id);
  });

  $('#logs-data').on('show.bs.modal', function(e) {
      stat_db();
  });

  $('#pemuact').on('hide.bs.modal', function(e) {
      clickPrefs();
  });

refresh_aprs_track();
aprs_timer_id = setInterval(refresh_aprs_track,180000);

</script>
</body>
</html>
